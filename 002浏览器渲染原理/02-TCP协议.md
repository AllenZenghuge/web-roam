# TCP协议：如何保证页面文件能被完整送达浏览器？

在衡量Web性能的时候有个重要的指标叫做**FP(First Paint)**,指从页面加载到首次开始绘制的时长，着一指标直接影响用户体验



互联网，实际上是一套理念和协议组成的体系架构

想要优化Web页面的加载速度，要理解网络，要理解网络协议。

不管是使用HTTP,WebSocket，他们都是基于TCP/IP的，学习TCP/IP协议，可以帮我们理解应用层的不同协议和使用



在网络中，一个文件通常会被拆分为很多数据包来进行传输，而这个过程又可能出现传输错误，丢失。那么如何保证页面能够被完整的送达浏览器呢？



## 数据包的旅程



1. 网络层
   1. IP协议 地址  每个主机地址唯一
2. 传输层（两者用一个）
   1. UDP 端口 不保证数据可靠性 速度快
   2. TCP 端口 重传机制 数据包排序机制

![image-20200520214024219](http://picbed.sedationh.cn/image-20200520214024219.png)

一个完整的 TCP 连接的生命周期包括了“**建立连接**”“**传输数据**”和“**断开连接**”三个阶段。

![image-20200520214144127](http://picbed.sedationh.cn/image-20200520214144127.png)

- **首先，建立连接阶段**。这个阶段是通过“三次握手”来建立客户端和服务器之间的连接。TCP 提供面向连接的通信传输。**面向连接**是指在数据通信开始之前先做好两端之间的准备工作。所谓**三次握手**，是指在建立一个 TCP 连接时，客户端和服务器总共要发送三个数据包以确认连接的建立。
- **其次，传输数据阶段**。在该阶段，**接收端需要对每个数据包进行确认操作**，也就是接收端在接收到数据包之后，需要发送确认数据包给发送端。所以当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制。同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照 TCP 头中的序号为其排序，从而保证组成完整的数据。
- **最后，断开连接阶段**。数据传输完毕之后，就要终止连接了，涉及到最后一个阶段“四次挥手”来保证双方都能断开连接。

## 总结

- 互联网中的数据是通过数据包来传输的，数据包在传输过程中容易丢失或出错。
- IP 负责把数据包送达目的主机。
- UDP 负责把数据包送达具体应用。
- 而 TCP 保证了数据完整地传输，它的连接可分为三个阶段：建立连接、传输数据和断开连接。