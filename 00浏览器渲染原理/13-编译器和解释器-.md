# 编译器和解释器：V8是如何执行一段JavaScript代码的？

前端工具和框架的自身更新速度非常块，而且还不断有新的出现。要想追赶上前端工具和框架的更新速度，你就需要抓住那些本质的知识，然后才能更加轻松地理解这些上层应用。比如我们接下来要介绍的 V8 执行机制，能帮助你从底层了解 JavaScript，也能帮助你深入理解语言转换器 Babel、语法检查工具 ESLint、前端框架 Vue 和 React 的一些底层实现机制。因此，了解 V8 的编译流程能让你对语言以及相关工具有更加充分的认识。

要深入理解 V8 的工作原理，你需要搞清楚一些概念和原理，比如接下来我们要详细讲解的**编译器（Compiler）、解释器（Interpreter）、抽象语法树（AST）、字节码（Bytecode）、即时编译器（JIT）**等概念，都是你需要重点关注的。



## 编译器和解释器

![image-20200529150400607](http://picbed.sedationh.cn/image-20200529150400607.png)

> AST -> 编译器生成的是二进制文件 -> 机器可以直接执行
>
> AST -> 解释器生成的是字节码文件 -> 需要解释器解释执行



## V8引擎是如何执行一段JS代码的

![image-20200529150811020](http://picbed.sedationh.cn/image-20200529150811020.png)

### 1.生成抽象语法树AST和执行上下文

高级语言是开发者可以理解的语言，但是让编译器或者解释器来理解就非常困难了。对于编译器或者解释器来说，它们可以理解的就是 AST 了。所以无论你使用的是解释型语言还是编译型语言，在编译过程中，它们都会生成一个 AST。这和渲染引擎将 HTML 格式文件转换为计算机可以理解的 DOM 树的情况类似。

```js
var myName = " 极客时间 "
function foo(){
  return 23;
}
myName = "geektime"
foo()
```

这段代码经过[javascript-ast](http://resources.jointjs.com/demos/javascript-ast)站点处理后，生成的 AST 结构如下：

![img](data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20joint-selector%3D%22svg%22%20id%3D%22v-249%22%20viewBox%3D%220%200%20440%20840%22%3E%3Cdefs%20joint-selector%3D%22defs%22%3E%3Cmarker%20id%3D%22v-2-857093843%22%20orient%3D%22auto%22%20overflow%3D%22visible%22%20markerUnits%3D%22userSpaceOnUse%22%3E%3Cpath%20id%3D%22v-124%22%20stroke%3D%22%23666%22%20fill%3D%22%23666%22%20transform%3D%22rotate(180)%22%20d%3D%22M%204%20-4%200%200%204%204%20z%22%2F%3E%3C%2Fmarker%3E%3C%2Fdefs%3E%3Cg%20joint-selector%3D%22layers%22%20class%3D%22joint-layers%22%3E%3Cg%20joint-selector%3D%22cells%22%20class%3D%22joint-cells-layer%20joint-viewport%22%3E%3Cg%20model-id%3D%22906f4cd3-5429-46e8-b9bc-796d35f2a9a7%22%20data-type%3D%22ast.Node%22%20id%3D%22j_48%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(0%2C0)%22%3E%3Crect%20id%3D%22v-148%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22black%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-149%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C37.8%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EProgram%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-150%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22e0b2e927-6f94-4c08-a827-97535185e8c8%22%20data-type%3D%22ast.Node%22%20id%3D%22j_49%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(80%2C50)%22%3E%3Crect%20id%3D%22v-153%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23232323%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-154%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C7.9%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EVariableDeclaration%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-155%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%2211f159f3-5e6c-4663-a486-bd51b10a7584%22%20data-type%3D%22ast.Node%22%20id%3D%22j_51%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(160%2C100)%22%3E%3Crect%20id%3D%22v-158%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23414141%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-159%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C10.7%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EVariableDeclarator%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-160%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%224a628de3-4551-426a-86bf-06c29e7b7cdb%22%20data-type%3D%22ast.Node%22%20id%3D%22j_53%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(240%2C150)%22%3E%3Crect%20id%3D%22v-163%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23ff5246%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-164%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C37.5%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EmyName%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-165%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22ca674772-48a0-439d-8d33-839de08ee3ba%22%20data-type%3D%22ast.Node%22%20id%3D%22j_55%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(240%2C200)%22%3E%3Crect%20id%3D%22v-168%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%2377c63d%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-169%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C29.5%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3E%22%C2%A0%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4%C2%A0%22%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-170%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%222f543bdd-ea16-488e-8218-c5631f7a945a%22%20data-type%3D%22ast.Node%22%20id%3D%22j_57%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(80%2C250)%22%3E%3Crect%20id%3D%22v-173%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23232323%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-174%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C24.2%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3Efunction%C2%A0foo()%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-175%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22cad5943c-13a7-466e-ae1f-23575923d35c%22%20data-type%3D%22ast.Node%22%20id%3D%22j_59%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(160%2C300)%22%3E%3Crect%20id%3D%22v-178%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23232323%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-179%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C17.8%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EBlockStatement%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-180%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22506691e7-0f49-4025-8c84-86318024c9a0%22%20data-type%3D%22ast.Node%22%20id%3D%22j_61%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(240%2C350)%22%3E%3Crect%20id%3D%22v-183%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23232323%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-184%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C14.9%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EReturnStatement%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-185%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%220dfbd392-40d0-4ea1-a8fc-f687ccea43d9%22%20data-type%3D%22ast.Node%22%20id%3D%22j_63%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(320%2C400)%22%3E%3Crect%20id%3D%22v-188%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%2377c63d%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-189%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C53.9%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3E23%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-190%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22787f31a6-a079-4828-b72c-b7c3b672f67c%22%20data-type%3D%22ast.Node%22%20id%3D%22j_65%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(80%2C450)%22%3E%3Crect%20id%3D%22v-193%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23232323%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-194%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C8.7%2C5.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EExpressionStateme%3C%2Ftspan%3E%3Ctspan%20dy%3D%221em%22%20x%3D%220%22%20class%3D%22v-line%22%3Ent%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-195%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22432047e0-8026-473a-8930-08b0d3fa88a8%22%20data-type%3D%22ast.Node%22%20id%3D%22j_67%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(160%2C500)%22%3E%3Crect%20id%3D%22v-198%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23fcbc2a%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-199%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C57%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3E%3D%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-200%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22eb574e81-3097-42b5-9e66-922f16eb42c5%22%20data-type%3D%22ast.Node%22%20id%3D%22j_69%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(240%2C550)%22%3E%3Crect%20id%3D%22v-203%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23ff5246%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-204%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C37.5%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EmyName%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-205%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22bb1c24be-3d57-4e64-af3b-e7decbc99088%22%20data-type%3D%22ast.Node%22%20id%3D%22j_71%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(240%2C600)%22%3E%3Crect%20id%3D%22v-208%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%2377c63d%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-209%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C30.8%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3E%22geektime%22%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-210%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%224e927e32-1572-4684-b0e5-ab6b1ce77714%22%20data-type%3D%22ast.Node%22%20id%3D%22j_73%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(80%2C650)%22%3E%3Crect%20id%3D%22v-213%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23232323%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-214%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C8.7%2C5.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3EExpressionStateme%3C%2Ftspan%3E%3Ctspan%20dy%3D%221em%22%20x%3D%220%22%20class%3D%22v-line%22%3Ent%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-215%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22d1975128-fd25-4796-ac37-db308fbce15b%22%20data-type%3D%22ast.Node%22%20id%3D%22j_75%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(160%2C700)%22%3E%3Crect%20id%3D%22v-218%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23232323%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-219%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C20.4%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3ECallExpression%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-220%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22edab58d2-05b9-4f23-bb69-ea2a624316ef%22%20data-type%3D%22ast.Node%22%20id%3D%22j_77%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(240%2C750)%22%3E%3Crect%20id%3D%22v-223%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%23ff5246%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-224%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C51.8%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3Efoo%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-225%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%2272011130-a27f-424b-aced-3cfb838b6388%22%20data-type%3D%22ast.Node%22%20id%3D%22j_79%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-node%20joint-element%20joint-theme-default%22%20transform%3D%22translate(240%2C800)%22%3E%3Crect%20id%3D%22v-228%22%20rx%3D%225%22%20ry%3D%225%22%20stroke%3D%22none%22%20fill%3D%22%2363c1f1%22%20width%3D%22120%22%20height%3D%2230%22%2F%3E%3Ctext%20id%3D%22v-229%22%20font-size%3D%2210%22%20xml%3Aspace%3D%22preserve%22%20y%3D%220.8em%22%20fill%3D%22white%22%20font-family%3D%22'Helvetica%20Neue%20Light'%2C'Helvetica%20Neue'%2C'Source%20Sans%20Pro'%2Csans-serif%22%20letter-spacing%3D%221px%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C32.3%2C10.7)%22%3E%3Ctspan%20dy%3D%220%22%20class%3D%22v-line%22%3Earguments%3C%2Ftspan%3E%3C%2Ftext%3E%3Cpath%20id%3D%22v-230%22%20stroke%3D%22%23666%22%20d%3D%22M%200%200%200%2010%20M%20-5%2010%205%2010%22%20visibility%3D%22hidden%22%20pointer-events%3D%22none%22%20transform%3D%22matrix(1%2C0%2C0%2C1%2C60%2C30)%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22eef4b9a8-b8c9-42bd-86c3-c1e5b18290b6%22%20data-type%3D%22ast.Link%22%20id%3D%22j_50%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-233%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%2060%2030%20L%2060%2065%20L%2080%2065%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%224ae1ee7b-230f-49e7-8093-a7479bfdfb7e%22%20data-type%3D%22ast.Link%22%20id%3D%22j_52%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-234%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20140%2080%20L%20140%20115%20L%20160%20115%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22b2c12899-705f-46fb-ad28-2ce4b39dfe96%22%20data-type%3D%22ast.Link%22%20id%3D%22j_54%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-235%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20220%20130%20L%20220%20165%20L%20240%20165%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22a49a473b-d8f7-4c64-8292-f8ab431e22b9%22%20data-type%3D%22ast.Link%22%20id%3D%22j_56%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-236%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20220%20130%20L%20220%20215%20L%20240%20215%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22812240c6-3651-4f32-b0f7-8630654aaf08%22%20data-type%3D%22ast.Link%22%20id%3D%22j_58%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-237%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%2060%2030%20L%2060%20265%20L%2080%20265%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22dd889209-8e9b-40d1-9e84-3315b568a707%22%20data-type%3D%22ast.Link%22%20id%3D%22j_60%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-238%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20140%20280%20L%20140%20315%20L%20160%20315%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%228400d3c1-a84f-486d-9d33-282715f196d2%22%20data-type%3D%22ast.Link%22%20id%3D%22j_62%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-239%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20220%20330%20L%20220%20365%20L%20240%20365%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%228847939c-67ed-4fff-95f7-56abe542ac65%22%20data-type%3D%22ast.Link%22%20id%3D%22j_64%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-240%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20300%20380%20L%20300%20415%20L%20320%20415%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22c0abc5bc-504b-4cb7-a9ba-63044071c15d%22%20data-type%3D%22ast.Link%22%20id%3D%22j_66%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-241%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%2060%2030%20L%2060%20465%20L%2080%20465%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22590b58be-fa1e-4e20-b144-078a9fbb94f6%22%20data-type%3D%22ast.Link%22%20id%3D%22j_68%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-242%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20140%20480%20L%20140%20515%20L%20160%20515%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22b28eeaea-9030-49d1-bc55-115d072b1941%22%20data-type%3D%22ast.Link%22%20id%3D%22j_70%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-243%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20220%20530%20L%20220%20565%20L%20240%20565%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%221cdd7a95-2a99-4464-8b5a-86fcfd52064f%22%20data-type%3D%22ast.Link%22%20id%3D%22j_72%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-244%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20220%20530%20L%20220%20615%20L%20240%20615%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%222bd16faa-163d-479f-96a4-b565b9932823%22%20data-type%3D%22ast.Link%22%20id%3D%22j_74%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-245%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%2060%2030%20L%2060%20665%20L%2080%20665%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22cc56a4f4-6323-4e4b-9764-a0c81c2b597d%22%20data-type%3D%22ast.Link%22%20id%3D%22j_76%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-246%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20140%20680%20L%20140%20715%20L%20160%20715%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%22a9698be3-f815-4d3e-bded-83eef1f55cd7%22%20data-type%3D%22ast.Link%22%20id%3D%22j_78%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-247%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20220%20730%20L%20220%20765%20L%20240%20765%22%2F%3E%3C%2Fg%3E%3Cg%20model-id%3D%229c6f4528-48a4-4510-83e5-8388858e6733%22%20data-type%3D%22ast.Link%22%20id%3D%22j_80%22%20class%3D%22joint-cell%20joint-type-ast%20joint-type-ast-link%20joint-link%20joint-theme-default%22%3E%3Cpath%20class%3D%22connection%22%20id%3D%22v-248%22%20fill%3D%22none%22%20stroke%3D%22%23666%22%20pointer-events%3D%22none%22%20marker-end%3D%22url(%23v-2-857093843)%22%20d%3D%22M%20220%20730%20L%20220%20815%20L%20240%20815%22%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3Cg%20joint-selector%3D%22tools%22%20class%3D%22joint-tools-layer%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E)

**AST是源代码的结构化表示**

AST 是非常重要的一种数据结构，在很多项目中有着广泛的应用。其中最著名的一个项目是 Babel。Babel 是一个被广泛使用的代码转码器，可以将 ES6 代码转为 ES5 代码，这意味着你可以现在就用 ES6 编写程序，而不用担心现有环境是否支持 ES6。Babel 的工作原理就是先将 ES6 源码转换为 AST，然后再将 ES6 语法的 AST 转换为 ES5 语法的 AST，最后利用 ES5 的 AST 生成 JavaScript 源代码。

除了 Babel 外，还有 ESLint 也使用 AST。ESLint 是一个用来检查 JavaScript 编写规范的插件，其检测流程也是需要将源码转换为 AST，然后再利用 AST 来检查代码规范化的问题。

**AST的生成过程**

1. 分词(tokenize)，词法分析 -> 源代码被拆解为token(语法上的最小单位)
   1. 如`var name = 'a' ` -> [var,name,=,'a'] 每个token有各自的属性[keyword,identifier,assignment,literal]
2. 解析(parse)，语法分析。将token通过语法规则，生产AST

### 2.生成字节码

**字节码就是介于 AST 和机器码之间的一种代码。但是与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码后才能执行。**

解释器**lignition**根据AST生产字节码，并解释执行字节码

> 其实一开始 V8 并没有字节码，而是直接将 AST 转换为机器码，由于执行机器码的效率是非常高效的，所以这种方式在发布后的一段时间内运行效果是非常好的。但是随着 Chrome 在手机上的广泛普及，特别是运行在 512M 内存的手机上，内存占用问题也暴露出来了，因为 V8 需要消耗大量的内存来存放转换后的机器码。为了解决内存占用问题，V8 团队大幅重构了引擎架构，引入字节码，并且抛弃了之前的编译器，最终花了将进四年的时间，实现了现在的这套架构。

### 3.代码执行

通常，如果有一段第一次执行的字节码，解释器 Ignition 会逐条解释执行。在执行字节码的过程中，如果发现有热点代码（HotSpot），比如一段代码被重复执行多次，这种就称为**热点代码**，那么后台的编译器 TurboFan 就会把该段热点的字节码编译为高效的机器码，然后当再次执行这段被优化的代码时，只需要执行编译后的机器码就可以了，这样就大大提升了代码的执行效率。

V8 的解释器和编译器的取名也很有意思。解释器 Ignition 是点火器的意思，编译器 TurboFan 是涡轮增压的意思，寓意着代码启动时通过点火器慢慢发动，一旦启动，涡轮增压介入，其执行效率随着执行时间越来越高效率，因为热点代码都被编译器 TurboFan 转换了机器码，直接执行机器码就省去了字节码“翻译”为机器码的过程。

其实字节码配合解释器和编译器是最近一段时间很火的技术，比如 Java 和 Python 的虚拟机也都是基于这种技术实现的，我们把这种技术称为**即时编译（JIT）**。具体到 V8，就是指解释器 Ignition 在解释执行字节码的同时，收集代码信息，当它发现某一部分代码变热了之后，TurboFan 编译器便闪亮登场，把热点的字节码转换为机器码，并把转换后的机器码保存起来，以备下次使用。

![image-20200529152208954](http://picbed.sedationh.cn/image-20200529152208954.png)

