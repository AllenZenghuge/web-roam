# 分层和合成机制：为什么CSS动画比JavaScript高效？

## 显示器是怎么显示图像的？

显示器有固定的刷新频率，通常是60HZ，即每秒更新60张图片，这些图片源于显卡中一个叫**前缓冲区**的地方

**显卡的职责**

显卡的职责是合成新的图像，并把图像保存到后缓冲区，60张合成好了，统一交换前后缓冲区，通常情况下，显卡的更新频率和显示器的刷新频率是一致的

**帧(frame)和帧率**

当我们滚动页面，缩放页面，渲染进程都会生成新的突破，发送到显卡的后缓冲区

这个生成的每一幅图片 -> 一帧

每秒生成了或者说更新了多少幅图片 -> 帧率



Chrome为了优化渲染的速度，引入分层和合成机制。



## 如何生成一帧图像

[参考渲染流程](https://github.com/SedationH/web-roam/blob/master/00%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86/05-%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B.md#%E9%97%AE%E9%A2%98%E6%8E%A2%E8%AE%A8)

总结来看方法有三

1. 重排
2. 重绘
3. 合成



其中效果最好的是合成，因为其所需路径最短，不是在主线程上的操作

*我们聚焦在方法3上进行讨论*

宏观和微观角度

## 分层和合成(宏观优化)

分层的好处在于一些元素发生变动，只需对其所在层进行重新渲染



其实现逻辑类似于PS的图层机制

布局树->层树->Paint列表->raster->合成



raster和合成都不在主线程上

**这也就意味着在执行合成操作时，是不会影响到主线程执行的**。这就是为什么经常主线程卡住了，但是 CSS 动画依然能执行的原因。



## 分块

优先绘制靠近视口的图块

向显卡发送图块的首次渲染时，先降低分辨率，后面再替换



> 如果说分层是从宏观上提升了渲染效率，那么分块则是从微观层面提升了渲染效率。
>
> 通常情况下，页面的内容都要比屏幕大得多，显示一个页面时，如果等待所有的图层都生成完毕，再进行合成的话，会产生一些不必要的开销，也会让合成图片的时间变得更久。
>
> 因此，合成线程会将每个图层分割为大小固定的图块，然后优先绘制靠近视口的图块，这样就可以大大加速页面的显示速度。不过有时候， 即使只绘制那些优先级最高的图块，也要耗费不少的时间，因为涉及到一个很关键的因素——**纹理上传**，这是因为从计算机内存上传到 GPU 内存的操作会比较慢。
>
> 为了解决这个问题，Chrome 又采取了一个策略：**在首次合成图块的时候使用一个低分辨率的图片**。比如可以是正常分辨率的一半，分辨率减少一半，纹理就减少了四分之三。在首次显示页面内容的时候，将这个低分辨率的图片显示出来，然后合成器继续绘制正常比例的网页内容，当正常比例的网页内容绘制完成后，再替换掉当前显示的低分辨率内容。这种方式尽管会让用户在开始时看到的是低分辨率的内容，但是也比用户在开始时什么都看不到要好。



## 如何利用分层技术优化代码

> 记住一点，能直接在合成线程中完成的任务都不会改变图层的内容，如文字信息的改变，布局的改变，颜色的改变，统统不会涉及，涉及到这些内容的变化就要牵涉到重排或者重绘了。
>
> 能直接在合成线程中实现的是整个图层的几何变换，透明度变换，阴影等，这些变换都不会影响到图层的内容。
>
> 比如滚动页面的时候，整个页面内容没有变化，这时候做的其实是对图层做上下移动，这种操作直接在合成线程里面就可以完成了。
>
> 再比如文章题目列子中的旋转操作，如果样式里面使用了will-change ，那么这些box元素都会生成单独的一层，那么在旋转操作时，只要在合成线程将这些box图层整体旋转到设置的角度，再拿旋转后的box图层和背景图层合成一张新图片，这个图片就是最终输出的一帧，整个过程都是在合成线程中实现的。



利用css

```css
.box {
  will-change: transform
}
```

让box变为单独的一层进行合成，等这些变换发生时，渲染引擎会通过合成线程直接去处理变换，这些变换并没有涉及到主线程，这样就大大提升了渲染的效率。**这也是 CSS 动画比 JavaScript 动画高效的原因**。

所以，如果涉及到一些可以使用合成线程来处理 CSS 特效或者动画的情况，就尽量使用 will-change 来提前告诉渲染引擎，让它为该元素准备独立的层。但是凡事都有两面性，每当渲染引擎为一个元素准备一个独立层的时候，它占用的内存也会大大增加，因为从层树开始，后续每个阶段都会多一个层结构，这些都需要额外的内存，所以你需要恰当地使用 will-change。

（还是有点模糊）